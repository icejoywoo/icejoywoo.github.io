---
layout: post
title: Python的内存管理简介
category: python
tags: ['python']
---

Python使用的垃圾回收方式是引用计数（reference counting）和垃圾回收（garbage collection），在2.0版本之前只用引用计数的方式。

Python的内存是通过memory pool来进行管理的。

引用计数作为一个简单的内存管理方式，一个比较大的缺陷就是循环引用的问题。为了解决循环引用的问题，需要额外的开销来发现循环引用并进行回收，会造成较大的停顿，gc代价较高。

在Python中设置有一个threshold，出发条件为：已分配的对象 - 释放的对象 > threshold，会启动垃圾回收器来回收。

可以通过gc模块来获取threshold，代码如下

```python
import gc
print gc.get_threshold()  # (700, 10, 10)
```

*你应该注意到这里的threshold是返回了三个值，后面会介绍Python内部对内存进行了分代（generations）管理的，分别叫作0、1、2，现在先忽略。*

当程序内存耗尽（Out of Memory）的时候，自动垃圾回收器（Automatic Garbage Collection）是不会运行的，而是Python解释器会抛出异常MemoryError，可以捕获该异常并进行处理。

垃圾回收的耗时是依赖要释放的对象的个数，而不是要释放对象的大小。基于这个原因，在工程实践中有几点建议：

1. 在程序中如果一次性释放大量的对象，最好手动执行一次gc（调用gc.collect()）
1. 对于长时间运行的服务程序，最好可以在适当的时机调用一次gc，使得循环引用越少越好（可以定时调度或者在某些服务器空闲的时间段进行调度）


# 参考资料：

1. Python Garbage Collection: <http://www.digi.com/wiki/developer/index.php/Python_Garbage_Collection>
1. [Python docs] gc — Garbage Collector interface: <https://docs.python.org/2/library/gc.html>
1. Garbage Collection for Python: <http://arctrix.com/nas/python/gc/>
